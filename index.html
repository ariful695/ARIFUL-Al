<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Gemini Clone</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Ensure UI fills screen without breaking on mobile */
        body {
            overscroll-behavior-y: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #app-root {
            display: flex;
            height: 100dvh; /* Dynamic viewport height for mobile */
            width: 100%;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
        }

        .messages-area {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 2rem;
        }

        /* Prevent markdown from breaking layout */
        .prose pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .prose code { font-size: 0.875rem; }

        /* Sidebar Transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 50;
        }

        @media (max-width: 768px) {
            #sidebar {
                position: absolute;
                transform: translateX(-100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark #loading-overlay { background: #0f172a; color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-slate-100 transition-colors duration-200">

    <div id="loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="font-medium">Initializing AI Interface...</p>
        </div>
    </div>

    <div id="app-root" class="hidden">
        <aside id="sidebar" class="w-72 bg-gray-100 dark:bg-slate-800 border-r border-gray-200 dark:border-slate-700 flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-slate-700 flex justify-between items-center">
                <h1 class="font-bold text-xl text-blue-600">Universal AI</h1>
                <button onclick="toggleSidebar()" class="md:hidden text-2xl"><i class="ph ph-x"></i></button>
            </div>
            
            <button onclick="createNewChat()" class="m-4 p-3 bg-white dark:bg-slate-700 rounded-xl shadow-sm hover:shadow-md transition flex items-center gap-2 border border-gray-200 dark:border-slate-600">
                <i class="ph ph-plus"></i> New Chat
            </button>

            <div id="chat-history-list" class="flex-1 overflow-y-auto px-2 space-y-1">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-slate-700 space-y-2">
                <button onclick="toggleSettings()" class="w-full text-left p-2 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-lg flex items-center gap-2">
                    <i class="ph ph-gear"></i> Settings
                </button>
                <button onclick="toggleDarkMode()" class="w-full text-left p-2 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-lg flex items-center gap-2">
                    <i id="theme-icon" class="ph ph-moon"></i> Appearance
                </button>
            </div>
        </aside>

        <main class="chat-container">
            <header class="p-4 flex items-center gap-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md sticky top-0 z-10 border-b border-gray-100 dark:border-slate-800">
                <button onclick="toggleSidebar()" class="text-2xl"><i class="ph ph-list"></i></button>
                <div class="flex-1">
                    <h2 id="current-chat-title" class="font-semibold truncate text-gray-700 dark:text-gray-200">New Conversation</h2>
                    <p id="current-model-display" class="text-xs text-gray-500"></p>
                </div>
            </header>

            <div id="messages-display" class="messages-area p-4 md:px-12 lg:px-24 space-y-6">
                </div>

            <footer class="p-4 md:px-12 lg:px-24 bg-gradient-to-t from-gray-50 dark:from-slate-900 to-transparent">
                <div class="max-w-4xl mx-auto relative group">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message AI..." 
                        class="w-full p-4 pr-14 rounded-2xl border border-gray-200 dark:border-slate-700 bg-white dark:bg-slate-800 focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none shadow-lg transition-all"
                        onkeydown="handleKeydown(event)"
                    ></textarea>
                    <button 
                        onclick="sendMessage()"
                        id="send-btn"
                        class="absolute right-3 bottom-3 p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition-all disabled:opacity-50"
                    >
                        <i class="ph ph-paper-plane-right text-xl"></i>
                    </button>
                </div>
                <p class="text-[10px] text-center mt-2 text-gray-400">Powered by OpenRouter. All data stored locally.</p>
            </footer>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Configuration</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Model ID</label>
                    <input type="text" id="model-input" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="google/gemini-2.0-flash-exp:free">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">System Prompt</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full p-2 rounded border dark:bg-slate-700 dark:border-slate-600" placeholder="You are a helpful assistant..."></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-500">Cancel</button>
                <button onclick="saveSettings()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            apiKey: localStorage.getItem('ai_api_key') || '',
            model: localStorage.getItem('ai_model') || 'google/gemini-2.0-flash-exp:free',
            systemPrompt: localStorage.getItem('ai_system_prompt') || 'You are a helpful AI assistant.',
            chats: JSON.parse(localStorage.getItem('ai_chats')) || [],
            currentChatId: null,
            isDark: localStorage.getItem('ai_theme') === 'dark',
            isStreaming: false
        };

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            renderChatHistory();
            if (state.chats.length > 0) {
                loadChat(state.chats[0].id);
            } else {
                createNewChat();
            }
            
            // Hide loader
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app-root').classList.remove('hidden');
            
            // Fill settings inputs
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('model-input').value = state.model;
            document.getElementById('system-prompt-input').value = state.systemPrompt;
            document.getElementById('current-model-display').innerText = state.model;
        });

        // --- Core Functions ---

        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            const text = inputEl.value.trim();
            
            if (!text || state.isStreaming) return;
            if (!state.apiKey) {
                alert("Please add your OpenRouter API Key in settings first!");
                toggleSettings();
                return;
            }

            // Find current chat
            const chatIdx = state.chats.findIndex(c => c.id === state.currentChatId);
            const userMsg = { role: 'user', content: text };
            state.chats[chatIdx].messages.push(userMsg);
            
            // Update UI
            inputEl.value = '';
            inputEl.style.height = 'auto';
            renderMessages();
            
            // Prepare AI message placeholder
            const aiMsg = { role: 'assistant', content: '' };
            state.chats[chatIdx].messages.push(aiMsg);
            const aiMsgIdx = state.chats[chatIdx].messages.length - 1;
            
            state.isStreaming = true;
            document.getElementById('send-btn').disabled = true;

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [
                            { role: 'system', content: state.systemPrompt },
                            ...state.chats[chatIdx].messages.slice(0, -1).map(m => ({ role: m.role, content: m.content }))
                        ],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                const content = data.choices[0]?.delta?.content || "";
                                fullContent += content;
                                state.chats[chatIdx].messages[aiMsgIdx].content = fullContent;
                                updateLastMessageUI(fullContent);
                            } catch (e) {}
                        }
                    }
                }
                
                // Auto-rename chat if it's the first message
                if (state.chats[chatIdx].title === "New Conversation") {
                    state.chats[chatIdx].title = text.substring(0, 30) + "...";
                    renderChatHistory();
                    updateHeader();
                }

            } catch (error) {
                state.chats[chatIdx].messages[aiMsgIdx].content = "⚠️ Error: " + error.message;
                renderMessages();
            } finally {
                state.isStreaming = false;
                document.getElementById('send-btn').disabled = false;
                saveToLocalStorage();
            }
        }

        // --- UI Rendering ---

        function renderMessages() {
            const container = document.getElementById('messages-display');
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            container.innerHTML = chat.messages.map((m, idx) => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300">
                    <div class="max-w-[85%] md:max-w-[70%] ${m.role === 'user' ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none px-4 py-2 shadow-sm' : 'text-gray-800 dark:text-gray-100'}">
                        ${m.role === 'assistant' ? `<div class="prose dark:prose-invert max-w-none">${marked.parse(m.content || '...')}</div>` : `<p class="whitespace-pre-wrap">${m.content}</p>`}
                    </div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        function updateLastMessageUI(content) {
            const container = document.getElementById('messages-display');
            const lastMsgDiv = container.lastElementChild?.querySelector('.prose');
            if (lastMsgDiv) {
                lastMsgDiv.innerHTML = marked.parse(content + ' ▎');
                container.scrollTop = container.scrollHeight;
            }
        }

        function renderChatHistory() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = state.chats.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="group flex items-center justify-between p-3 rounded-xl cursor-pointer transition ${state.currentChatId === chat.id ? 'bg-gray-200 dark:bg-slate-700' : 'hover:bg-gray-200 dark:hover:bg-slate-700'}">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="ph ph-chat-centered-text"></i>
                        <span class="truncate text-sm">${chat.title}</span>
                    </div>
                    <button onclick="deleteChat(event, '${chat.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition">
                        <i class="ph ph-trash"></i>
                    </button>
                </div>
            `).reverse().join('');
        }

        // --- Helpers & Event Handlers ---

        function createNewChat() {
            const id = Date.now().toString();
            state.chats.push({
                id,
                title: "New Conversation",
                messages: [],
                created: new Date()
            });
            state.currentChatId = id;
            saveToLocalStorage();
            renderChatHistory();
            renderMessages();
            updateHeader();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function loadChat(id) {
            state.currentChatId = id;
            renderMessages();
            renderChatHistory();
            updateHeader();
            if (window.innerWidth < 768) toggleSidebar();
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            state.chats = state.chats.filter(c => c.id !== id);
            if (state.currentChatId === id) {
                state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
            }
            if (!state.currentChatId) createNewChat();
            saveToLocalStorage();
            renderChatHistory();
            renderMessages();
        }

        function updateHeader() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            document.getElementById('current-chat-title').innerText = chat?.title || "Universal AI";
            document.getElementById('current-model-display').innerText = state.model;
        }

        function handleKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
            // Auto-resize textarea
            e.target.style.height = 'auto';
            e.target.style.height = (e.target.scrollHeight) + 'px';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key-input').value;
            state.model = document.getElementById('model-input').value;
            state.systemPrompt = document.getElementById('system-prompt-input').value;
            
            localStorage.setItem('ai_api_key', state.apiKey);
            localStorage.setItem('ai_model', state.model);
            localStorage.setItem('ai_system_prompt', state.systemPrompt);
            
            updateHeader();
            toggleSettings();
        }

        function toggleDarkMode() {
            state.isDark = !state.isDark;
            initTheme();
        }

        function initTheme() {
            if (state.isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').className = 'ph ph-sun';
            } else {
                document.documentElement.classList.remove('dark');
                document.getElementById('theme-icon').className = 'ph ph-moon';
            }
            localStorage.setItem('ai_theme', state.isDark ? 'dark' : 'light');
        }

        function saveToLocalStorage() {
            localStorage.setItem('ai_chats', JSON.stringify(state.chats));
        }
    </script>
</body>
  </html>
  
